#!/bin/sh

VERSION_LABEL=ellipsis-`git rev-parse --short HEAD`
PUBLIC_ASSETS_DIR=/tmp/public-assets

ASSETS_BUCKET=ellipsis-assets
EB_BUCKET=elasticbeanstalk-us-east-1-170937251085
APP_NAME="My First Elastic Beanstalk Application"
TARGET_ENV="production"

if [ "$1" = "stag01" ]; then
  TARGET_ENV="stag01"
  STAG01_ACCOUNT_ID="458075145501"
  EB_BUCKET="elasticbeanstalk-us-east-1-${STAG01_ACCOUNT_ID}"
  ASSETS_BUCKET="assets-${STAG01_ACCOUNT_ID}"
  APP_NAME="playapp"
  AWS_ELLIPSIS_PROFILE="el-stag01-${STAG01_ACCOUNT_ID}"
fi

printf "\n\n Deploying to ${TARGET_ENV} \n\n"

hold_on_to_your_butts() {
  printf "\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m1\e[38;5;52m0\e[38;5;52m1\e[38;5;52m1\e[38;5;138m0\e[38;5;145m0\e[38;5;52m1\e[0m \e[0m \e[38;5;53m0\e[38;5;139m1\e[38;5;231m1\e[38;5;231m1\e[38;5;231m0\e[38;5;231m1\e[38;5;231m1\e[38;5;225m0\e[38;5;181m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;17m1\e[38;5;24m0\e[0m \e[0m \e[38;5;17m0\e[38;5;17m1\e[38;5;17m1\e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;53m0\e[38;5;225m1\e[38;5;96m0\e[38;5;139m0\e[38;5;182m1\e[38;5;188m1\e[38;5;145m1\e[38;5;96m0\e[38;5;139m0\e[38;5;188m0\e[38;5;231m1\e[38;5;231m0\e[38;5;231m1\e[38;5;231m1\e[38;5;231m1\e[38;5;224m0\e[0m \e[0m \e[0m \e[38;5;17m1\e[38;5;24m1\e[38;5;61m1\e[38;5;18m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;52m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;59m0\e[38;5;189m1\e[38;5;96m0\e[38;5;139m0\e[38;5;102m1\e[38;5;145m0\e[38;5;182m1\e[38;5;96m0\e[38;5;95m1\e[38;5;95m0\e[38;5;132m1\e[38;5;225m0\e[38;5;231m0\e[38;5;231m1\e[38;5;231m1\e[38;5;231m0\e[38;5;145m1\e[0m \e[38;5;17m1\e[38;5;24m0\e[38;5;24m1\e[38;5;17m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;52m1\e[38;5;95m0\e[38;5;95m0\e[38;5;95m1\e[38;5;52m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;59m1\e[38;5;231m0\e[38;5;139m0\e[38;5;52m0\e[38;5;60m1\e[38;5;145m1\e[38;5;182m1\e[38;5;95m1\e[38;5;53m0\e[38;5;95m0\e[38;5;139m1\e[38;5;225m1\e[38;5;224m0\e[38;5;224m1\e[38;5;225m0\e[38;5;231m0\e[38;5;231m0\e[38;5;189m0\e[38;5;146m0\e[38;5;67m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;88m0\e[38;5;131m0\e[38;5;131m0\e[38;5;174m1\e[38;5;174m1\e[38;5;95m0\e[38;5;52m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;231m1\e[38;5;59m1\e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;96m1\e[38;5;95m1\e[38;5;96m1\e[38;5;182m1\e[38;5;231m1\e[38;5;224m1\e[38;5;230m1\e[38;5;231m0\e[38;5;231m1\e[38;5;104m1\e[38;5;25m0\e[38;5;104m1\e[38;5;59m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;52m0\e[38;5;88m1\e[38;5;88m0\e[38;5;131m1\e[38;5;174m0\e[38;5;138m1\e[38;5;94m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;102m0\e[38;5;145m1\e[0m \e[0m \e[0m \e[38;5;52m1\e[38;5;59m1\e[38;5;139m1\e[38;5;96m1\e[38;5;140m0\e[38;5;224m1\e[38;5;224m0\e[38;5;181m0\e[38;5;231m1\e[38;5;231m0\e[38;5;189m1\e[38;5;61m0\e[38;5;60m0\e[38;5;104m1\e[38;5;146m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m1\e[38;5;88m1\e[38;5;95m0\e[38;5;95m0\e[38;5;88m0\e[38;5;52m0\e[38;5;52m1\e[38;5;52m1\e[0m \e[38;5;102m0\e[38;5;139m0\e[38;5;59m1\e[38;5;53m1\e[38;5;52m1\e[38;5;53m1\e[38;5;182m0\e[38;5;188m1\e[38;5;139m1\e[38;5;131m1\e[38;5;181m0\e[38;5;231m1\e[38;5;225m1\e[38;5;104m1\e[38;5;60m1\e[38;5;61m0\e[38;5;103m0\e[38;5;61m1\e[38;5;188m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m1\e[38;5;52m1\e[38;5;88m0\e[38;5;88m0\e[38;5;95m0\e[38;5;95m0\e[38;5;95m0\e[38;5;88m1\e[38;5;52m1\e[38;5;59m1\e[38;5;95m0\e[38;5;59m1\e[38;5;52m1\e[38;5;52m0\e[38;5;95m0\e[38;5;52m1\e[38;5;131m0\e[38;5;138m1\e[38;5;132m1\e[38;5;181m0\e[38;5;182m0\e[38;5;17m1\e[38;5;17m0\e[38;5;68m1\e[38;5;25m0\e[38;5;68m1\e[38;5;145m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;52m0\e[38;5;52m1\e[38;5;52m1\e[38;5;52m1\e[38;5;52m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;94m1\e[38;5;95m0\e[38;5;95m0\e[38;5;138m0\e[38;5;96m0\e[38;5;53m1\e[38;5;182m1\e[38;5;224m1\e[38;5;225m1\e[38;5;140m0\e[38;5;68m1\e[38;5;231m0\e[38;5;58m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;95m1\e[38;5;225m1\e[38;5;145m0\e[38;5;52m0\e[38;5;52m0\e[0m \e[0m \e[0m \e[38;5;138m1\e[38;5;52m1\e[0m \e[0m \e[38;5;53m0\e[38;5;52m0\e[38;5;95m0\e[38;5;224m1\e[38;5;231m0\e[38;5;182m0\e[38;5;146m1\e[38;5;231m1\e[38;5;102m1\e[0m \e[38;5;17m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[38;5;59m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;59m1\e[38;5;95m1\e[38;5;88m1\e[38;5;52m0\e[38;5;52m0\e[0m \e[38;5;52m1\e[38;5;96m0\e[38;5;59m0\e[38;5;53m1\e[38;5;59m0\e[38;5;138m0\e[38;5;132m0\e[38;5;95m0\e[38;5;174m1\e[38;5;181m1\e[38;5;59m0\e[38;5;102m0\e[38;5;59m0\e[38;5;17m0\e[38;5;59m0\e[38;5;17m1\e[38;5;17m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[38;5;59m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;17m1\e[38;5;53m1\e[38;5;138m0\e[38;5;145m1\e[38;5;139m0\e[38;5;95m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[38;5;59m1\e[38;5;59m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;96m0\e[38;5;103m1\e[38;5;60m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;59m0\e[38;5;52m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;53m1\e[38;5;96m1\e[38;5;103m1\e[38;5;140m1\e[38;5;182m1\e[38;5;182m1\e[38;5;60m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;53m0\e[0m \e[0m \e[38;5;59m1\e[38;5;103m1\e[38;5;231m1\e[38;5;231m1\e[38;5;60m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;181m0\e[38;5;224m0\e[38;5;53m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;17m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;95m1\e[38;5;131m0\e[38;5;95m1\e[0m \e[0m \e[0m \e[0m \e[38;5;17m0\e[38;5;17m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;95m1\e[38;5;102m1\e[38;5;188m0\e[38;5;59m0\e[38;5;52m1\e[38;5;138m1\e[38;5;188m0\e[38;5;188m1\e[38;5;102m1\e[38;5;17m0\e[38;5;17m0\e[38;5;17m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;53m1\e[38;5;138m1\e[38;5;145m0\e[38;5;145m0\e[38;5;182m1\e[38;5;188m0\e[38;5;231m1\e[38;5;60m1\e[0m \e[0m \e[0m \e[38;5;60m1\e[38;5;146m0\e[38;5;189m1\e[38;5;189m0\e[38;5;146m0\e[38;5;96m0\e[38;5;17m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[38;5;60m1\e[38;5;59m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;59m0\e[38;5;139m1\e[38;5;225m0\e[38;5;224m0\e[38;5;231m0\e[38;5;231m0\e[38;5;231m0\e[38;5;102m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;59m1\e[38;5;103m1\e[38;5;188m0\e[38;5;225m1\e[38;5;188m1\e[38;5;102m0\e[0m \e[0m \e[38;5;52m1\e[0m \e[0m
\e[38;5;60m0\e[38;5;102m0\e[38;5;102m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;52m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;53m0\e[38;5;175m0\e[38;5;225m0\e[38;5;231m1\e[38;5;231m1\e[38;5;59m0\e[38;5;17m1\e[38;5;17m0\e[38;5;17m0\e[38;5;17m0\e[0m \e[0m \e[0m \e[0m \e[38;5;53m1\e[38;5;96m0\e[38;5;59m0\e[38;5;102m1\e[38;5;182m0\e[38;5;95m1\e[38;5;52m0\e[38;5;89m1\e[38;5;53m0
\e[38;5;60m1\e[38;5;102m0\e[38;5;103m1\e[38;5;59m1\e[0m \e[38;5;59m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;53m1\e[38;5;53m1\e[38;5;53m1\e[38;5;52m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;95m1\e[38;5;189m0\e[38;5;231m0\e[38;5;231m0\e[38;5;231m1\e[38;5;231m0\e[38;5;60m0\e[38;5;59m1\e[38;5;53m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m1\e[38;5;52m0\e[38;5;59m0\e[38;5;52m0\e[38;5;52m0\e[38;5;53m0
\e[38;5;59m1\e[38;5;103m1\e[38;5;146m0\e[38;5;146m1\e[0m \e[38;5;59m0\e[38;5;145m0\e[38;5;59m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;53m0\e[38;5;53m0\e[38;5;53m1\e[38;5;53m0\e[38;5;53m0\e[38;5;52m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;138m1\e[38;5;182m1\e[38;5;188m1\e[38;5;224m0\e[38;5;224m0\e[38;5;102m1\e[38;5;53m1\e[38;5;52m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m1\e[0m \e[0m \e[38;5;52m1
\e[38;5;146m1\e[38;5;103m0\e[38;5;103m0\e[38;5;153m0\e[38;5;103m0\e[0m \e[38;5;189m1\e[38;5;189m1\e[38;5;146m0\e[38;5;103m0\e[38;5;96m0\e[38;5;102m1\e[38;5;59m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m1\e[38;5;52m1\e[38;5;53m1\e[38;5;53m0\e[38;5;53m1\e[38;5;52m1\e[38;5;52m0\e[0m \e[38;5;52m1\e[0m \e[0m \e[38;5;52m0\e[38;5;52m1\e[38;5;52m1\e[38;5;95m0\e[38;5;95m1\e[38;5;95m0\e[38;5;131m1\e[38;5;95m0\e[38;5;52m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[38;5;231m1\e[38;5;231m0\e[38;5;146m0\e[38;5;103m0\e[38;5;146m0\e[38;5;59m1\e[38;5;152m1\e[38;5;231m0\e[38;5;231m1\e[38;5;231m0\e[38;5;231m0\e[38;5;231m1\e[38;5;231m0\e[38;5;188m0\e[38;5;96m0\e[0m \e[0m \e[38;5;53m0\e[38;5;59m0\e[38;5;53m1\e[38;5;53m0\e[38;5;96m0\e[38;5;138m0\e[38;5;139m1\e[38;5;96m0\e[38;5;17m0\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[38;5;52m0\e[38;5;52m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[38;5;231m1\e[38;5;231m0\e[38;5;231m0\e[38;5;189m0\e[38;5;146m0\e[38;5;60m0\e[38;5;59m0\e[38;5;231m1\e[38;5;231m1\e[38;5;231m0\e[38;5;231m0\e[38;5;231m1\e[38;5;231m1\e[38;5;231m0\e[38;5;231m1\e[38;5;231m0\e[38;5;145m0\e[38;5;96m0\e[38;5;96m0\e[38;5;96m0\e[38;5;95m0\e[38;5;139m0\e[38;5;139m0\e[38;5;96m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[38;5;231m0\e[38;5;231m1\e[38;5;231m0\e[38;5;231m1\e[38;5;231m0\e[38;5;231m0\e[38;5;60m0\e[38;5;110m0\e[38;5;231m1\e[38;5;231m1\e[38;5;231m1\e[38;5;231m0\e[38;5;231m0\e[38;5;231m1\e[38;5;231m1\e[38;5;231m0\e[38;5;231m0\e[38;5;231m0\e[38;5;145m0\e[38;5;96m1\e[38;5;139m1\e[38;5;225m0\e[38;5;145m1\e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m \e[0m
\e[0m\n\n"
  printf "Hold on to your butts...\n"
}

MAGENTA=`tput setaf 5`
GREEN=`tput setaf 2`
BOLD=`tput bold`
PLAIN=`tput sgr0`

if [ -z "$ELLIPSIS_DEPLOY_TOKEN" ];then
  printf "${GREEN}You need to set the ELLIPSIS_DEPLOY_TOKEN environment \
        variable. Visit https://bot.ellipsis.ai/list_api_tokens and add
        the deploy token to your environment.${PLAIN}"
  exit 1
fi

GIT_USERNAME=`git config user.name`
DISPLAY_USERNAME=${GIT_USERNAME:-$USER}
printf "${GREEN}Announcing the deployment to #dev...${PLAIN}"
curl -f --data "message=Heads%20up!%20${DISPLAY_USERNAME}%20is%20preparing%20a%20deploy%20to%20${TARGET_ENV}.&responseContext=slack&channel=dev&token=${ELLIPSIS_DEPLOY_TOKEN}" https://bot.ellipsis.ai/api/say || (printf "${GREEN}The deploy announcement failed. Please check the ELLIPSIS_DEPLOY_TOKEN environment variable.${PLAIN}" && exit 1)
printf "\n"
pushd `git rev-parse --show-toplevel` > /dev/null
git diff-index --quiet HEAD --
if [ $? -eq 1 ];then
  printf "\n\n${GREEN}You have uncommitted changes in your working directory.\n"
  printf "Deal with them first!${PLAIN}\n\n";
  exit 1
fi

if [ ! -f node_modules/.bin/eslint ];then
  printf "\n\n${GREEN}eslint${PLAIN} is not installed.\n"
  printf "Try running ${GREEN}npm install${PLAIN}.\n\n";
  exit 1
fi

if [ ! -f node_modules/.bin/jest ];then
  printf "\n\n${GREEN}jest${PLAIN} is not installed.\n"
  printf "Try running ${GREEN}npm install${PLAIN}.\n\n";
  exit 1
fi

type activator >/dev/null 2>&1 || {
  printf "\n\n${GREEN}activator${PLAIN} is not installed.\n"
  printf "Visit ${GREEN}https://www.lightbend.com/activator/download${PLAIN}"
  printf "to download it.";
  exit 1
}

printf "Running eslint...\n"
npm run lint
if [ $? -eq 1 ];then
  read -p "eslint failed. You should probably stop. Do you want to continue anyway? [y/N]: " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]];then
    printf "See ya later.\n"
    exit 1
  else
    printf "Okay, continuing anyway...\n"
  fi
fi

printf "Running jest...\n"
# npm test
if [ $? -eq 1 ];then
  printf "\n\n${BOLD}JavaScript tests failed.${PLAIN} You should probably stop.\n"
  read -p "Do you want to continue anyway? [y/N]: " -n 1 -r
  printf "\n"
  if [[ ! $REPLY =~ ^[Yy]$ ]];then
    printf "You are wise.\n"
    exit 1
  else
    hold_on_to_your_butts
  fi
fi

printf "Running activator test...\n"
activator test
if [ $? -eq 1 ];then
  printf "\n\n";
  read -p "${BOLD}Scala tests failed.${PLAIN} You should probably stop. Do you want to continue anyway? [y/N]: " -n 1 -r
  printf "\n";
  if [[ ! $REPLY =~ ^[Yy]$ ]];then
    printf "You are wise.\n";
    exit 1
  else
    hold_on_to_your_butts
  fi
fi

touch conf/version.conf
echo application.version=\"`git rev-parse --short HEAD`\" >conf/version.conf
activator docker:stage
mkdir -p target/docker/.ebextensions
cp .ebextensions/* target/docker/.ebextensions/
cp deploy/Docker* target/docker/
pushd target/docker > /dev/null
BUNDLE=$VERSION_LABEL.zip
BUNDLE_PATH=~/Desktop/$BUNDLE
zip -qq -r $BUNDLE_PATH .
popd > /dev/null


if ! type aws > /dev/null;then
  printf "\n\nYou need to set up the aws CLI tools.\n"
  printf "Try ${GREEN}brew install awscli${PLAIN} if youâ€™re using brew,\n"
  printf "or go to ${GREEN}https://aws.amazon.com/cli/${PLAIN}.\n";
else
  if [ -z ${AWS_ELLIPSIS_PROFILE+x} ];then
    printf "You need to set the ${GREEN}AWS_ELLIPSIS_PROFILE${PLAIN}"
    printf "env var with the profile to use for AWS.\n"
    printf "
1. If you havenâ€™t already, run ${GREEN}aws configure --profile ellipsis${PLAIN} to set up a
   profile.

   You will need an AWS access key and secret key. If you donâ€™t have one, you
   can create a new one from the users page:

   ${GREEN}https://console.aws.amazon.com/iam/home?region=us-east-1#users${PLAIN}

   Use ${GREEN}text${PLAIN} for the output format, and ${GREEN}us-east-1${PLAIN} for the region.

2. Add a line to your ${GREEN}.bashrc${PLAIN} file:

   ${GREEN}export AWS_ELLIPSIS_PROFILE=ellipsis${PLAIN}

3. Open a new terminal or run ${GREEN}source ~/.bashrc${PLAIN}, then try again.\n";

  else
    printf "${MAGENTA}Syncing assets with S3...${PLAIN}";
    mkdir -p $PUBLIC_ASSETS_DIR
    rm -rf $PUBLIC_ASSETS_DIR/*
    unzip -qq target/docker/stage/opt/docker/lib/ellipsis.ellipsis-1.0-SNAPSHOT-assets.jar -d $PUBLIC_ASSETS_DIR/
    aws --profile $AWS_ELLIPSIS_PROFILE s3 sync $PUBLIC_ASSETS_DIR/public s3://$ASSETS_BUCKET/ --acl=public-read --quiet
    S3_KEY=`date +'%Y-%m-%d'`-$BUNDLE
    printf "${MAGENTA}Uploading ${GREEN}$BUNDLE${MAGENTA} to S3...${PLAIN}";
    aws --profile $AWS_ELLIPSIS_PROFILE s3 cp $BUNDLE_PATH s3://$EB_BUCKET/$S3_KEY
    aws --profile $AWS_ELLIPSIS_PROFILE elasticbeanstalk create-application-version \
    --application-name "$APP_NAME" \
    --version-label $VERSION_LABEL \
    --source-bundle S3Bucket=$EB_BUCKET,S3Key=$S3_KEY \
    --process;
  fi
fi

osascript -e "display notification \"The build script has ended.\" with title \"Build $VERSION_LABEL\" sound name \"Sosumi\""
curl -f --data "message=ðŸš€%20Build%20**${VERSION_LABEL}**%20is%20ready%20for%20deployment%20on%20${TARGET_ENV}.&responseContext=slack&channel=dev&token=${ELLIPSIS_DEPLOY_TOKEN}" https://bot.ellipsis.ai/api/say || (printf "${GREEN}Warning: the post-build announcement failed.${PLAIN}" && exit 1)
printf "Done.\n\n"
